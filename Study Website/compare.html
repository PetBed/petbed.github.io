<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Study Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    .calendar-grid {
      grid-template-columns: repeat(7, minmax(0, 1fr));
    }

    .day {
      transition: all 0.2s ease-in-out;
    }

    .day:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }

    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f5f9;
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    .task-item:hover .delete-task-btn,
    .subtask-item:hover .delete-subtask-btn {
      opacity: 1;
    }

    .nav-btn {
      transition: all 0.2s ease-in-out;
    }

    .nav-btn.active {
      background-color: #3b82f6;
      color: white;
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-800">
  <!-- Loading Indicator -->
  <div id="loading-indicator" class="min-h-screen flex-col items-center justify-center hidden">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600"></div>
    <p class="mt-4 text-slate-500 font-semibold">Loading your dashboard...</p>
  </div>

  <!-- Main App Container -->
  <div id="app-container" class="min-h-screen flex-col p-4 md:p-8 hidden">
    <header class="mb-8 flex justify-between items-start">
      <div>
        <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Study Dashboard</h1>
        <p id="welcome-message" class="text-slate-500 mt-1"></p>
        <div class="mt-4 flex items-center bg-slate-200 rounded-lg p-1 max-w-sm">
          <button id="nav-dashboard"
            class="nav-btn active w-1/2 text-center py-2 px-4 rounded-md font-semibold">Dashboard</button>
          <button id="nav-study"
            class="nav-btn w-1/2 text-center py-2 px-4 rounded-md font-semibold text-slate-600">Study Tracker</button>
        </div>
      </div>
      <button id="logout-btn"
        class="ml-4 py-2 px-4 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition">Logout</button>
    </header>

    <main id="dashboard-page" class="">
      <div id="motivational-quote" class="text-center bg-white p-4 rounded-2xl shadow-sm mb-8 text-slate-600 italic">
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2 space-y-8">
          <div class="bg-white p-6 rounded-2xl shadow-sm">
            <h2 class="text-xl font-bold text-slate-900 mb-4">Study Time Analysis</h2>
            <div class="h-80 relative"><canvas id="study-chart"></canvas></div>
          </div>
        </div>
        <div class="space-y-8">
          <div class="bg-white p-6 rounded-2xl shadow-sm">
            <h2 class="text-xl font-bold text-slate-900 mb-4">Upcoming Exams</h2>
            <div id="upcoming-exams-container" class="space-y-3"></div>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm">
            <h2 class="text-xl font-bold text-slate-900 mb-4">Daily Streak</h2>
            <div id="streak-container" class="text-center p-4 bg-orange-50 border-2 border-orange-200 rounded-lg"></div>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm">
            <h2 class="text-xl font-bold text-slate-900 mb-4">Your Next 3 Tasks</h2>
            <div id="next-todos-container" class="space-y-3"></div>
          </div>
        </div>
      </div>
    </main>

    <main id="study-page" class="hidden flex-grow grid grid-cols-1 lg:grid-cols-3 gap-8">
      <div class="lg:col-span-2 space-y-8">
        <div class="bg-white p-6 rounded-2xl shadow-sm">
          <div id="calendar-feature">
            <div class="flex items-center justify-between mb-6">
              <h2 id="month-year" class="text-xl font-bold text-slate-900"></h2>
              <div class="flex items-center space-x-2"><button id="prev-month"
                  class="p-2 rounded-full bg-slate-100 hover:bg-slate-200"><svg xmlns="http://www.w3.org/2000/svg"
                    width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="15 18 9 12 15 6"></polyline>
                  </svg></button><button id="next-month" class="p-2 rounded-full bg-slate-100 hover:bg-slate-200"><svg
                    xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 18 15 12 9 6"></polyline>
                  </svg></button></div>
            </div>
            <div class="grid calendar-grid gap-1 text-center font-semibold text-slate-600 mb-2">
              <div>Sun</div>
              <div>Mon</div>
              <div>Tue</div>
              <div>Wed</div>
              <div>Thu</div>
              <div>Fri</div>
              <div>Sat</div>
            </div>
            <div id="calendar-days" class="grid calendar-grid gap-2"></div>
          </div>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm">
          <h2 class="text-xl font-bold text-slate-900 mb-6">Exam Countdowns</h2>
          <div id="countdown-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>
      </div>
      <div class="space-y-8">
        <div class="bg-white p-6 rounded-2xl shadow-sm">
          <h3 class="text-lg font-bold text-slate-900 mb-4">Task List</h3>
          <div class="mb-4 space-y-2"><input type="text" id="task-input" placeholder="Enter a new task..."
              class="w-full p-2 border border-slate-300 rounded-lg">
            <div class="grid grid-cols-3 gap-2"><select id="task-subject"
                class="w-full p-2 border border-slate-300 rounded-lg text-sm"></select><input type="number"
                id="task-time" placeholder="Mins" class="w-full p-2 border border-slate-300 rounded-lg"><input
                type="date" id="task-deadline" class="w-full p-2 border border-slate-300 rounded-lg text-sm"></div>
            <button id="add-task-btn" class="w-full py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg">Add
              Task</button>
          </div>
          <div id="task-list" class="space-y-2 max-h-[40vh] overflow-y-auto pr-2"></div>
          <div id="task-error" class="text-red-500 text-xs text-center mt-2 h-4"></div>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm">
          <h3 class="text-lg font-bold text-slate-900 mb-4">Study Tracker</h3>
          <div class="space-y-4">
            <div class="text-center p-4 bg-slate-100 rounded-lg">
              <p id="mode-indicator" class="text-sm font-semibold text-slate-500 uppercase">Focus</p>
              <p id="timer-display" class="text-6xl font-bold font-mono text-slate-800 my-2">25:00</p><select
                id="pomodoro-subject" class="w-full p-2 border border-slate-300 rounded-lg text-sm"></select>
            </div>
            <div class="flex space-x-2"><input type="number" id="focus-duration" value="25"
                class="w-full p-2 text-center border rounded-lg"><input type="number" id="break-duration" value="5"
                class="w-full p-2 text-center border rounded-lg"></div>
            <div class="grid grid-cols-2 gap-2"><button id="play-pause-btn"
                class="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg">Start</button><button
                id="skip-btn"
                class="w-full py-3 px-4 bg-slate-200 text-slate-700 font-semibold rounded-lg">Skip</button></div>
            <div>
              <h4 class="text-md font-bold text-slate-800 mt-4 mb-2">Study Log</h4>
              <div id="study-log-container" class="space-y-2 max-h-40 overflow-y-auto pr-2"></div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
      <h3 class="text-xl font-bold mb-4">Add Event</h3>
      <p id="modal-date" class="mb-6 text-slate-500"></p><input type="text" id="event-title"
        class="w-full p-3 border rounded-lg mb-4" placeholder="Event title">
      <div class="flex justify-end space-x-3"><button id="close-modal"
          class="px-4 py-2 bg-slate-100 rounded-lg">Cancel</button><button id="save-event"
          class="px-4 py-2 bg-blue-600 text-white rounded-lg">Save</button></div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // --- DOM Elements ---
      const loadingIndicator = document.getElementById('loading-indicator');
      const appContainer = document.getElementById('app-container');
      const logoutBtn = document.getElementById('logout-btn');
      const welcomeMessage = document.getElementById('welcome-message');
      const dashboardPage = document.getElementById('dashboard-page');
      const studyPage = document.getElementById('study-page');
      const navDashboard = document.getElementById('nav-dashboard');
      const navStudy = document.getElementById('nav-study');
      const monthYearEl = document.getElementById('month-year');
      const calendarDaysEl = document.getElementById('calendar-days');
      const prevMonthBtn = document.getElementById('prev-month');
      const nextMonthBtn = document.getElementById('next-month');
      const countdownContainer = document.getElementById('countdown-container');
      const taskListEl = document.getElementById('task-list');
      const taskInput = document.getElementById('task-input');
      const taskSubjectSelect = document.getElementById('task-subject');
      const taskTimeInput = document.getElementById('task-time');
      const taskDeadlineInput = document.getElementById('task-deadline');
      const addTaskBtn = document.getElementById('add-task-btn');
      const taskErrorEl = document.getElementById('task-error');
      const timerDisplay = document.getElementById('timer-display');
      const modeIndicator = document.getElementById('mode-indicator');
      const pomodoroSubjectSelect = document.getElementById('pomodoro-subject');
      const focusDurationInput = document.getElementById('focus-duration');
      const breakDurationInput = document.getElementById('break-duration');
      const playPauseBtn = document.getElementById('play-pause-btn');
      const skipBtn = document.getElementById('skip-btn');
      const studyLogContainer = document.getElementById('study-log-container');
      const eventModal = document.getElementById('event-modal');
      const closeModalBtn = document.getElementById('close-modal');
      const saveEventBtn = document.getElementById('save-event');
      const eventTitleInput = document.getElementById('event-title');
      const modalDateEl = document.getElementById('modal-date');
      const upcomingExamsContainer = document.getElementById('upcoming-exams-container');
      const nextTodosContainer = document.getElementById('next-todos-container');
      const studyChartCanvas = document.getElementById('study-chart');
      const motivationalQuoteEl = document.getElementById('motivational-quote');
      const streakContainerEl = document.getElementById('streak-container');

      // --- State ---
      let studyChart = null; let currentDate = new Date(); let events = {}; let tasks = []; let studyLogs = {}; let selectedDate = null; let timerInterval = null; let timeLeft = 25 * 60; let isPaused = true; let currentMode = 'focus'; let studyStreak = 0; let lastStudyDay = ''; let currentUser = null;

      // --- Constants & Config ---
      const API_URL = 'https://wot-tau.vercel.app';
      const subjectColors = { 'Malay': '#8B0000', 'Chinese': '#E63946', 'English': '#1D3557', 'Moral': '#6A4C93', 'History': '#D2691E', 'Geography': '#606C38', 'RBT': '#6C757D', 'PJK': '#9EF01A', 'Science': '#2D6A4F', 'Mathematics': '#00B4D8', 'Art': '#E6399B', 'Other': '#64748b' };
      const RBT_ACCENT = '#FFD60A';
      const exams = [{ subject: 'Malay Paper 1', date: '2025-10-03T06:50:00' }, { subject: 'Malay Paper 2', date: '2025-10-03T08:25:00' }, { subject: 'Chinese', date: '2025-10-03T09:45:00' }, { subject: 'English Paper 1', date: '2025-10-07T06:50:00' }, { subject: 'English Paper 2', date: '2025-10-07T08:25:00' }, { subject: 'Moral', date: '2025-10-07T09:45:00' }, { subject: 'History', date: '2025-10-08T07:00:00' }, { subject: 'Geography', date: '2025-10-08T09:40:00' }, { subject: 'RBT', date: '2025-10-09T06:50:00' }, { subject: 'PJK', date: '2025-10-09T08:20:00' }, { subject: 'Science', date: '2025-10-09T09:40:00' }, { subject: 'Mathematics', date: '2025-10-10T07:00:00' }, { subject: 'Art', date: '2025-10-10T09:40:00' }];
      const quotes = ["The secret of getting ahead is getting started.", "The expert in anything was once a beginner.", "Believe you can and you're halfway there.", "Well done is better than well said.", "Strive for progress, not perfection.", "The future belongs to those who believe in the beauty of their dreams.", "Success is the sum of small efforts, repeated day in and day out.", "Don't watch the clock; do what it does. Keep going.", "It does not matter how slowly you go as long as you do not stop.", "The pain you feel today will be the strength you feel tomorrow."];

      // --- UTILITY FUNCTIONS ---
      const getDateString = (d) => d.toISOString().split('T')[0];
      const getColorForSubject = (s) => Object.keys(subjectColors).find(k => s.toLowerCase().includes(k.toLowerCase())) ? subjectColors[Object.keys(subjectColors).find(k => s.toLowerCase().includes(k.toLowerCase()))] : subjectColors['Other'];
      const formatTime = (s) => `${String(Math.floor(s / 60)).padStart(2, '0')}:${String(s % 60).padStart(2, '0')}`;
      const formatLogTime = (s) => {
        const hours = Math.floor(s / 3600);
        const minutes = Math.floor((s % 3600) / 60);
        const seconds = Math.floor(s % 60);
        return `${hours > 0 ? `${hours}h ` : ''}${minutes > 0 ? `${minutes}m ` : ''}${seconds}s`;
      };

      // --- App Initialization & Auth Check ---
      async function checkAuthAndInitialize() {
        const user = localStorage.getItem('studyUser');
        if (user) {
          currentUser = JSON.parse(user);
          loadingIndicator.style.display = 'flex';
          appContainer.classList.add('hidden');
          welcomeMessage.textContent = `Welcome back, ${currentUser.username}!`;
          await initializeApp();
          loadingIndicator.style.display = 'none';
          appContainer.classList.remove('hidden');
          appContainer.style.display = 'flex';
        } else {
          window.location.href = 'auth.html';
        }
      }

      async function initializeApp() {
        await loadDataFromDB();
        populateCalendarWithExams();
        renderCalendar();
        renderCountdowns();
        const populateSubjects = () => [taskSubjectSelect, pomodoroSubjectSelect].forEach(sel => { sel.innerHTML = ''; Object.keys(subjectColors).forEach(s => sel.add(new Option(s, s))); });
        populateSubjects();
        renderTasks();
        renderStudyLogs();
        updateTimerDisplay();
        showPage('dashboard');
      }

      function handleLogout() {
        localStorage.removeItem('studyUser');
        currentUser = null;
        window.location.href = 'auth.html';
      }

      // --- Event Listeners ---
      logoutBtn.addEventListener('click', handleLogout);
      navDashboard.addEventListener('click', () => showPage('dashboard'));
      navStudy.addEventListener('click', () => showPage('study'));
      prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
      nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
      // Event delegation for tasks
      taskListEl.addEventListener('click', (e) => {
        if (e.target.classList.contains('task-checkbox')) {
          const taskEl = e.target.closest('.task-item');
          const task = tasks.find(t => t._id === taskEl.dataset.id);
          toggleTask(task);
        }
        if (e.target.classList.contains('delete-task-btn')) {
          const taskEl = e.target.closest('.task-item');
          deleteTask(taskEl.dataset.id);
        }
        if (e.target.classList.contains('add-subtask-btn')) {
          const taskId = e.target.dataset.taskId;
          const inputEl = document.getElementById(`subtask-input-${taskId}`);
          addSubTask(taskId, inputEl.value);
          inputEl.value = '';
        }
        if (e.target.classList.contains('subtask-checkbox')) {
          const subtaskEl = e.target.closest('.subtask-item');
          const taskId = subtaskEl.dataset.parentId;
          const subtaskId = subtaskEl.dataset.id;
          toggleSubTask(taskId, subtaskId, e.target.checked);
        }
      });
      addTaskBtn.addEventListener('click', addTask); taskInput.addEventListener('keydown', (e) => e.key === 'Enter' && addTask());
      playPauseBtn.addEventListener('click', playPauseTimer);
      skipBtn.addEventListener('click', () => {
        if (currentMode === 'focus') { saveStudyLogs(); }
        switchMode(currentMode === 'focus' ? 'break' : 'focus');
      });
      focusDurationInput.addEventListener('change', () => currentMode === 'focus' && switchMode('focus'));
      breakDurationInput.addEventListener('change', () => currentMode === 'break' && switchMode('break'));
      closeModalBtn.addEventListener('click', closeModal); saveEventBtn.addEventListener('click', saveEvent); eventModal.addEventListener('click', (e) => e.target === eventModal && closeModal());
      setInterval(updateAllCountdowns, 1000);

      // --- Data Management (DB & Local) ---
      async function loadDataFromDB() {
        await loadTasks();
        await loadStudyLogs();
        await loadStreak();
        checkStreak();
      }

      function showPage(page) { if (page === 'dashboard') { dashboardPage.classList.remove('hidden'); studyPage.classList.add('hidden'); navDashboard.classList.add('active'); navStudy.classList.remove('active'); renderDashboard(); } else { dashboardPage.classList.add('hidden'); studyPage.classList.remove('hidden'); navDashboard.classList.remove('active'); navStudy.classList.add('active'); } }
      function renderDashboard() { renderMotivationalQuote(); renderUpcomingExams(); renderStudyChart(); renderNextTodos(); renderStreak(); }
      function renderMotivationalQuote() { motivationalQuoteEl.textContent = `"${quotes[Math.floor(Math.random() * quotes.length)]}"`; }
      function renderUpcomingExams() { const now = new Date(); const upcoming = exams.filter(e => new Date(e.date) > now).sort((a, b) => new Date(a.date) - new Date(b.date)); upcomingExamsContainer.innerHTML = ''; if (upcoming.length === 0) { upcomingExamsContainer.innerHTML = `<p class="text-slate-500">No upcoming exams!</p>`; return; } const nextDate = new Date(upcoming[0].date).toDateString(); const nextExams = upcoming.filter(e => new Date(e.date).toDateString() === nextDate); upcomingExamsContainer.innerHTML = `<p class="text-sm font-semibold text-slate-600 mb-2">On ${new Date(nextExams[0].date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}</p>`; nextExams.forEach(exam => { const el = document.createElement('div'); el.className = 'flex items-center p-3 bg-slate-100 rounded-lg'; el.innerHTML = `<div class="w-1.5 h-10 rounded-full mr-3" style="background-color: ${getColorForSubject(exam.subject)};"></div><div><p class="font-semibold text-slate-800">${exam.subject}</p><p class="text-sm text-slate-500">${new Date(exam.date).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}</p></div>`; upcomingExamsContainer.appendChild(el); }); }
      function renderStudyChart() { const ctx = studyChartCanvas.getContext('2d'); const labels = Object.keys(studyLogs); const data = labels.map(label => (studyLogs[label] / 3600).toFixed(2)); if (studyChart) studyChart.destroy(); if (labels.length === 0) { ctx.clearRect(0, 0, studyChartCanvas.width, studyChartCanvas.height); ctx.font = "16px Inter"; ctx.fillStyle = "#94a3b8"; ctx.textAlign = "center"; ctx.fillText("Log study time to see your progress!", studyChartCanvas.width / 2, 50); return; } studyChart = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Hours Studied', data, backgroundColor: labels.map(l => subjectColors[l] || subjectColors['Other']), borderRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { display: false }, title: { display: true, text: 'Hours' } }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } } }); }
      function renderNextTodos() { const incomplete = tasks.filter(t => !t.completed).slice(0, 3); nextTodosContainer.innerHTML = ''; if (incomplete.length === 0) { nextTodosContainer.innerHTML = `<div class="text-center p-4 bg-green-50 border-2 border-green-200 rounded-lg"><p class="font-semibold text-green-700">All caught up!</p></div>`; return; } incomplete.forEach(task => { const el = document.createElement('div'); el.className = 'flex items-start p-3 bg-slate-100 rounded-lg space-x-3'; el.innerHTML = `<div class="mt-1 w-2.5 h-2.5 rounded-full" style="background-color: ${getColorForSubject(task.subject)};"></div><div><p class="font-semibold text-slate-800">${task.text}</p><p class="text-sm text-slate-500">Due: ${new Date(task.deadline).toLocaleDateString()}</p></div>`; nextTodosContainer.appendChild(el); }); }
      function renderStreak() { streakContainerEl.innerHTML = `<p class="text-slate-600">You're on a</p><p class="text-3xl font-bold text-orange-600">${studyStreak} day streak! 🔥</p>`; }

      async function checkStreak() {
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        const todayStr = getDateString(today);
        const yesterdayStr = getDateString(yesterday);
        if (lastStudyDay && lastStudyDay !== todayStr && lastStudyDay !== yesterdayStr) {
          studyStreak = 0;
          await saveStreak();
        }
      }
      async function updateStreak() {
        const todayStr = getDateString(new Date());
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = getDateString(yesterday);
        if (lastStudyDay === todayStr) return;
        if (lastStudyDay === yesterdayStr) {
          studyStreak++;
        } else {
          studyStreak = 1;
        }
        lastStudyDay = todayStr;
        await saveStreak();
      }

      // --- Task Management (DB) ---
      async function loadTasks() { if (!currentUser) return; try { const response = await fetch(`${API_URL}/api/study/tasks?userId=${currentUser.id}`); tasks = await response.json(); renderTasks(); } catch (error) { console.error("Failed to fetch tasks:", error); } }
      async function addTask() { /* ... unchanged with optimistic update ... */ }
      async function toggleTask(task) { /* ... unchanged ... */ }
      async function deleteTask(taskId) { /* ... unchanged ... */ }

      // --- NEW Sub-task functions ---
      async function addSubTask(taskId, text) {
        if (!text.trim()) return;

        const task = tasks.find(t => t._id === taskId);
        if (!task) return;

        const tempSubId = `temp_${Date.now()}`;
        const optimisticSubTask = { _id: tempSubId, text, completed: false };
        task.subTasks.push(optimisticSubTask);
        renderTasks();

        try {
          const response = await fetch(`${API_URL}/api/study/tasks/${taskId}/subtasks`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text })
          });
          if (!response.ok) throw new Error('Server error');
          const updatedTask = await response.json();
          const taskIndex = tasks.findIndex(t => t._id === taskId);
          if (taskIndex !== -1) {
            tasks[taskIndex] = updatedTask;
          }
          renderTasks();
        } catch (error) {
          console.error("Failed to add sub-task:", error);
          task.subTasks = task.subTasks.filter(st => st._id !== tempSubId); // Rollback
          renderTasks();
        }
      }

      async function toggleSubTask(taskId, subtaskId, completed) {
        const task = tasks.find(t => t._id === taskId);
        const subTask = task?.subTasks.find(st => st._id === subtaskId);
        if (!subTask) return;

        const oldStatus = subTask.completed;
        subTask.completed = completed; // Optimistic update
        renderTasks();

        try {
          const response = await fetch(`${API_URL}/api/study/tasks/${taskId}/subtasks/${subtaskId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ completed })
          });
          if (!response.ok) throw new Error('Server error');
        } catch (error) {
          console.error("Failed to toggle sub-task:", error);
          subTask.completed = oldStatus; // Rollback
          renderTasks();
        }
      }

      // --- Study Log Management (DB) ---
      async function loadStudyLogs() { /* ... unchanged ... */ }
      async function saveStudyLogs() { /* ... unchanged ... */ }

      // --- Streak Management (DB) ---
      async function loadStreak() { /* ... unchanged ... */ }
      async function saveStreak() { /* ... unchanged ... */ }

      // --- Core Functionality ---
      function populateCalendarWithExams() { /* ... unchanged ... */ }
      function renderCalendar() { /* ... unchanged ... */ }
      function renderCountdowns() { /* ... unchanged ... */ }
      function updateAllCountdowns() { /* ... unchanged ... */ }
      function renderTasks() {
        taskListEl.innerHTML = '';
        if (!tasks.length) {
          taskListEl.innerHTML = `<p class="text-slate-400 text-center py-4">No tasks yet. Add one!</p>`;
          return;
        }
        tasks.forEach(task => {
          const el = document.createElement('div');
          el.className = 'task-item p-3 bg-slate-100 rounded-lg';
          el.dataset.id = task._id;

          const completedClass = task.completed ? ' line-through text-slate-400' : '';
          let subtasksHtml = '<div class="pl-6 mt-2 space-y-1">';
          if (task.subTasks && task.subTasks.length > 0) {
            task.subTasks.forEach(st => {
              const subCompletedClass = st.completed ? ' line-through text-slate-500' : '';
              subtasksHtml += `
                                <div class="subtask-item flex items-center" data-id="${st._id}" data-parent-id="${task._id}">
                                    <input type="checkbox" ${st.completed ? 'checked' : ''} class="subtask-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 cursor-pointer">
                                    <p class="ml-2 text-sm ${subCompletedClass}">${st.text}</p>
                                </div>
                            `;
            });
          }
          subtasksHtml += '</div>';

          el.innerHTML = `
                        <div class="flex items-start justify-between group">
                            <div class="flex items-start flex-grow">
                                <input type="checkbox" ${task.completed ? 'checked' : ''} class="task-checkbox mt-1 mr-3 h-5 w-5 rounded border-gray-300 text-blue-600 cursor-pointer">
                                <div>
                                    <p class="font-medium text-slate-700 ${completedClass}">${task.text}</p>
                                    <div class="flex items-center space-x-2 text-xs mt-1 ${completedClass}">
                                        <span class="flex items-center font-semibold" style="color:${getColorForSubject(task.subject)};"><span class="w-2 h-2 rounded-full mr-1.5" style="background-color:${getColorForSubject(task.subject)};"></span>${task.subject}</span>
                                        <span>•</span><span>${task.time} mins</span><span>•</span><span>${new Date(task.deadline).toLocaleDateString()}</span>
                                    </div>
                                </div>
                            </div>
                            <button class="delete-task-btn opacity-0 group-hover:opacity-100 text-slate-400 hover:text-red-500 ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                        </div>
                        ${subtasksHtml}
                        <div class="mt-2 pl-6 flex items-center gap-2">
                            <input type="text" id="subtask-input-${task._id}" class="w-full text-sm p-1 border border-slate-200 rounded" placeholder="Add sub-task...">
                            <button class="add-subtask-btn text-xs bg-blue-500 text-white rounded px-2 py-1" data-task-id="${task._id}">Add</button>
                        </div>
                    `;
          taskListEl.appendChild(el);
        });
      }
      function renderStudyLogs() { /* ... unchanged ... */ }
      function updateTimerDisplay() { timerDisplay.textContent = formatTime(timeLeft); }
      function playNotificationSound() { /* ... unchanged ... */ }
      function switchMode(mode) { /* ... unchanged ... */ }
      function playPauseTimer() { /* ... unchanged ... */ }
      function logStudySession() { /* ... unchanged ... */ }
      function openModal(date) { /* ... unchanged ... */ }
      function closeModal() { eventModal.classList.add('hidden'); }
      function saveEvent() { /* ... unchanged ... */ }

      // --- App Start ---
      checkAuthAndInitialize();
    });
  </script>
</body>

</html>